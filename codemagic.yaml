workflows:
  default-workflow:
    name: Rally FE workflow
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      android_signing:
        - rally_key
      groups:
        - keystore_credentials
        - firebase_credentials
        - azure_credentials
        - other
      flutter: stable
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "master"
          include: true
          source: true
      cancel_previous_builds: false
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $CM_BUILD_DIR/node_modules
    scripts:
      - name: Installing Dependencies
        script: |
          set -e
          sudo apt-get update && sudo apt-get install -y curl jq
          echo "Installing dependencies..."
          flutter clean
          flutter pub get

      - name: Create .env file
        script: |
          set -e
          echo "Creating .env file..."
          echo "API_BACKEND_URL=$API_BACKEND_URL" > .env
          echo ".env file created with API_BACKEND_URL"

      - name: Generate l10n files
        script: |
          set -e
          echo "Generating localization files with slang..."
          dart run slang

      - name: Setup Firebase
        script: |
          set -e
          echo "Installing Firebase CLI..."
          curl -sL https://firebase.tools | bash
          
          echo "Activating FlutterFire CLI..."
          dart pub global activate flutterfire_cli
          export PATH="$PATH:$HOME/.pub-cache/bin"
          
          echo "Configuring Firebase..."
          flutterfire configure \
            --project=$FIREBASE_PROJECT_ID \
            --platforms=android \
            --android-package-name=$ANDROID_PACKAGE_NAME \
            --yes

      - name: Build Android
        script: |
          echo "Running Android build..."
          STATE_FILE="$CM_BUILD_DIR/state.env"
          touch "$STATE_FILE"
          set +e
          flutter build apk --release
          BUILD_ANDROID_APK_EXIT_CODE=$?
          flutter build appbundle --release
          BUILD_ANDROID_AAB_EXIT_CODE=$?
          
          # Consider Android successful only if both succeed
          if [ "$BUILD_ANDROID_APK_EXIT_CODE" = "0" ] && [ "$BUILD_ANDROID_AAB_EXIT_CODE" = "0" ]; then
            BUILD_ANDROID_EXIT_CODE=0
          else
            BUILD_ANDROID_EXIT_CODE=1
          fi

          sed -i '/^BUILD_ANDROID_EXIT_CODE=/d' "$STATE_FILE"
          echo "BUILD_ANDROID_EXIT_CODE=$BUILD_ANDROID_EXIT_CODE" >> "$STATE_FILE"
                    
          if [ "$BUILD_ANDROID_EXIT_CODE" -eq 0 ]; then
            echo "ANDROID_STATUS=SUCCESS" >> "$STATE_FILE"
          else
            echo "ANDROID_STATUS=FAILED" >> "$STATE_FILE"
          fi
          set -e

      - name: Verify APK Signature
        script: |
          set -e
          echo "Verifying APK signature..."
          jarsigner -verify -verbose -certs build/app/outputs/flutter-apk/app-release.apk
          echo "✅ APK signature verified successfully!"

      - name: Get OAuth2 token
        script: |
          STATE_FILE="$CM_BUILD_DIR/state.env"
          source "$STATE_FILE"
          set -e
          echo "Fetching Microsoft Graph OAuth2 token..."
          TOKEN=$(curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$CLIENT_ID&scope=https://graph.microsoft.com/.default&client_secret=$CLIENT_SECRET&grant_type=client_credentials" \
            "https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token" | jq -r .access_token)

          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "Failed to obtain access token."
            exit 1
          fi

          echo "Token acquired."
          echo "TOKEN=$TOKEN" >> "$STATE_FILE"

      - name: Upload Android build to SharePoint
        script: |
          STATE_FILE="$CM_BUILD_DIR/state.env"
          source "$STATE_FILE"

          if [ -z "$TOKEN" ]; then
            echo "No OAuth token available — skipping upload"
            exit 0
          fi

          if [ "$BUILD_ANDROID_EXIT_CODE" != "0" ]; then
            echo "Android build failed - skipping upload"
            exit 0
          fi
          
          set -e
          BASE_FOLDER="Frontend/Builds"

          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | tr -d '\r')
          VERSION_BUILD="${VERSION}+${BUILD_NUMBER}"
          PLATFORM_FOLDER="Android"
          BUILD_FOLDER="$BASE_FOLDER/$VERSION_BUILD/$PLATFORM_FOLDER"

          echo "Preparing Android upload → $BUILD_FOLDER"

          for FOLDER in "$BASE_FOLDER" "$BASE_FOLDER/$VERSION_BUILD" "$BUILD_FOLDER"; do
              echo "Ensuring folder exists: $FOLDER"
              EXISTS=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drives/${DRIVE_ID}/root:/$FOLDER" | jq -r '.id // empty')
              echo "  Found $FOLDER"
              if [ -z "$EXISTS" ]; then
              # Create folder if not exist
              echo "  Creating $FOLDER..."
              FOLDER_RESPONSE=$(curl -s -X PUT \
                  -H "Authorization: Bearer $TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"folder": {}, "@microsoft.graph.conflictBehavior": "fail"}' \
                  "https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drives/${DRIVE_ID}/root:/$FOLDER")
              fi
          done

          upload_file() {
            local FILE_PATH="$1"
            local MIME_TYPE="$2"
            local FILE_NAME=$(basename "$FILE_PATH")

            if [ ! -f "$FILE_PATH" ]; then
              echo "File not found: $FILE_PATH — skipping"
              return
            fi

            echo "⬆ Uploading $FILE_NAME..."
            START_TIME=$(date +%s)

            RESPONSE=$(curl -s -w "%{http_code}" -o upload_result.json \
              -X PUT \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: $MIME_TYPE" \
              --data-binary @"$FILE_PATH" \
              "https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drives/${DRIVE_ID}/root:/$BUILD_FOLDER/$FILE_NAME:/content")

            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))

            if [ "$RESPONSE" != "201" ] && [ "$RESPONSE" != "200" ]; then
              echo "Upload failed for $FILE_NAME (HTTP $RESPONSE)"
              cat upload_result.json
              return
            fi

            FILE_WEBURL=$(jq -r '.webUrl' upload_result.json)
            echo "✅ Uploaded: $FILE_WEBURL"
            echo "⏱ Duration: ${DURATION}s"
          }

          upload_file "build/app/outputs/bundle/release/app-release.aab" "application/octet-stream"
          upload_file "build/app/outputs/flutter-apk/app-release.apk" "application/vnd.android.package-archive"

      - name: Build iOS
        script: |
          echo "Running iOS build..."
          STATE_FILE="$CM_BUILD_DIR/state.env"
          touch "$STATE_FILE"
          set +e
          flutter build ios --release --no-codesign
          BUILD_IOS_EXIT_CODE=$?
          sed -i '/^BUILD_IOS_EXIT_CODE=/d' "$STATE_FILE"
          echo "BUILD_IOS_EXIT_CODE=$BUILD_IOS_EXIT_CODE" >> "$STATE_FILE"
          if [ "$BUILD_IOS_EXIT_CODE" -eq 0 ]; then
            echo "IOS_STATUS=SUCCESS" >> "$STATE_FILE"
          else
            echo "IOS_STATUS=FAILED" >> "$STATE_FILE"
          fi
          set -e
          
      - name: Upload iOS build to SharePoint
        script: |
          STATE_FILE="$CM_BUILD_DIR/state.env"
          source "$STATE_FILE"

          if [ -z "$TOKEN" ]; then
            echo "No OAuth token available — skipping upload"
            exit 0
          fi

          if [ "$BUILD_IOS_EXIT_CODE" != "0" ]; then
            echo "iOS build failed - skipping upload"
            exit 0
          fi

          set -e
          BASE_FOLDER="Frontend/Builds"

          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | tr -d '\r')
          VERSION_BUILD="${VERSION}+${BUILD_NUMBER}"
          PLATFORM_FOLDER="iOS"
          BUILD_FOLDER="$BASE_FOLDER/$VERSION_BUILD/$PLATFORM_FOLDER"

          echo "Preparing iOS upload → $BUILD_FOLDER"

          for FOLDER in "$BASE_FOLDER" "$BASE_FOLDER/$VERSION_BUILD" "$BUILD_FOLDER"; do
              echo "Ensuring folder exists: $FOLDER"
              EXISTS=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drives/${DRIVE_ID}/root:/$FOLDER" | jq -r '.id // empty')
              echo "  Found $FOLDER"
              if [ -z "$EXISTS" ]; then
              # Create folder if not exist
              echo "  Creating $FOLDER..."
              FOLDER_RESPONSE=$(curl -s -X PUT \
                  -H "Authorization: Bearer $TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"folder": {}, "@microsoft.graph.conflictBehavior": "fail"}' \
                  "https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drives/${DRIVE_ID}/root:/$FOLDER")
              fi
          done

          IPA_PATH=$(find build/ios/ipa -name "*.ipa" -type f 2>/dev/null | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "No .ipa file found — skipping"
            exit 0
          fi

          echo "⬆Uploading $(basename "$IPA_PATH")..."
          START_TIME=$(date +%s)

          RESPONSE=$(curl -s -w "%{http_code}" -o upload_result_ios.json \
            -X PUT \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$IPA_PATH" \
            "https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drives/${DRIVE_ID}/root:/$BUILD_FOLDER/$(basename "$IPA_PATH"):/content")

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          if [ "$RESPONSE" != "201" ] && [ "$RESPONSE" != "200" ]; then
            echo "Upload failed (HTTP $RESPONSE)"
            cat upload_result_ios.json
            exit 1
          fi

          FILE_WEBURL=$(jq -r '.webUrl' upload_result_ios.json)
          echo "✅ Uploaded: $FILE_WEBURL"
          echo "⏱ Duration: ${DURATION}s"

    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - build/app/outputs/bundle/release/*.aab
      - build/ios/ipa/*.ipa
    publishing:
      email:
        recipients:
          - khang.nguyen@rally-go.com
        notify:
          success: true
          failure: true
      scripts:
        - name: Send Notification
          script: |
            #!/bin/bash
            STATE_FILE="$CM_BUILD_DIR/state.env"
            source "$STATE_FILE"

            if [ "$BUILD_ANDROID_EXIT_CODE" -eq 0 ] && [ "$BUILD_IOS_EXIT_CODE" -eq 0 ]; then
              echo "BUILD_STATUS=SUCCESS" >> "$STATE_FILE"
            else
              echo "BUILD_STATUS=FAILED" >> "$STATE_FILE"
            fi

            source "$STATE_FILE"
            
            VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | tr -d '\r' 2>/dev/null || echo "Unknown")
            VERSION_BUILD="${VERSION}+${BUILD_NUMBER}"
            
            # Construct JSON Payload
            cat <<EOF > payload.json
            {
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "type": "AdaptiveCard",
                    "version": "1.2",
                    "body": [
                      {
                        "type": "TextBlock",
                        "text": "Rally FE Build Notification",
                        "weight": "Bolder",
                        "size": "Medium"
                      },
                      {
                        "type": "TextBlock",
                        "text": "Workflow: Rally FE workflow",
                        "isSubtle": true,
                        "wrap": true
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          { "title": "Status:", "value": "${BUILD_STATUS}" },
                          { "title": "Build Number:", "value": "#${BUILD_NUMBER}" },
                          { "title": "Version:", "value": "${VERSION_BUILD}" },
                          { "title": "Branch:", "value": "${CM_BRANCH}" },
                          { "title": "Commit:", "value": "${CM_COMMIT:0:8}" }
                        ]
                      },
                      {
                        "type": "TextBlock",
                        "text": "Platform Statuses:",
                        "weight": "Bolder",
                        "spacing": "Medium"
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          { "title": "Android:", "value": "${ANDROID_STATUS}" },
                          { "title": "iOS:", "value": "${IOS_STATUS}" }
                        ]
                      }
                    ],
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "View Build",
                        "url": "${CM_BUILD_URL}"
                      }
                    ],
                    "msteams": {
                      "width": "Full"
                    }
                  }
                }
              ]
            }
            EOF
              
            (
              set +e
              curl -H "Content-Type: application/json" -d @payload.json "$TEAMS_WEBHOOK_URL"
            ) || echo "Warning: Teams notification failed"

            echo "Teams notification sent"